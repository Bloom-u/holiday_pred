# 发明名称
一种基于分解建模的延迟可得约束下节假日感知交通流量预测方法、装置及存储介质

# 摘要
本发明公开了一种基于分解建模的延迟可得约束下节假日感知交通流量预测方法、装置及存储介质，面向按天采样的全国交通流量单序列预测场景。在标签存在延迟可得约束的条件下，本发明以“预测日 t 仅可使用至 t-k 的真实观测”为信息边界，通过构建节假日与春节窗口上下文特征、训练期统计映射特征以及延迟对齐的动态滞后/滚动/趋势特征，构造特征向量。进一步提出“常态基线 + 事件增量”的分解建模框架：训练常态基线模型拟合全量日常水平；训练反事实基线模型仅在非节假日且非春运窗口样本上拟合无事件影响的基线；以真实值与反事实基线预测值之差作为残差标签，在节假日/春运窗口样本上训练增量模型预测事件增量，并将基线预测作为增量模型的辅助输入以增强对当前水平的感知。预测阶段根据样本是否属于事件日选择基线并叠加对应增量，得到最终预测，同时输出反事实基线与增量分量以增强可解释性。本发明在满足无信息泄露的前提下提升了节假日及春运窗口期间的预测精度与可解释性，特别适用于峰值稀疏、分布漂移明显且需可追溯解释的交通流量预测应用。

# 技术领域
本发明属于交通流量预测与时间序列预测技术领域，具体涉及一种在标签延迟可得约束下、基于节假日特征工程与分解建模（baseline + uplift）的交通流量预测方法、装置及存储介质。

# 背景技术
交通流量预测常具有显著的周期性（周内、年内）、节假日制度驱动的结构突变以及春节等关键窗口的强非平稳峰形。传统单模型方案在全量样本上统一拟合，往往在“常态日占多数、峰值日占少数”的分布下倾向于对峰值与突变保守，表现为节假日或春运窗口系统性偏低估。另一方面，实际业务系统中真实流量数据存在落地延迟，预测日 t 往往只能使用至 t-k 的已核验数据，若特征构造未显式对齐该信息边界，容易引入信息泄露并导致离线评估偏乐观、线上效果不稳定。
因此，亟需一种同时满足：①在 t-k 信息约束下严格对齐特征；②对节假日/春运窗口的增量效应进行结构化建模；③输出具有可解释分解的预测结果；④在小样本年份数据条件下仍保持稳定泛化能力的预测方法与系统。

# 发明内容
## 要解决的技术问题
本发明要解决的技术问题至少包括：
1) 在真实标签延迟可得（t-k）约束下，保证预测特征不使用 t-1 及未来真实值，避免信息泄露；
2) 提升节假日与春运窗口等峰值稀疏场景的预测精度，降低系统性低估；
3) 提供“常态水平/反事实基线/事件增量”的可解释输出，便于业务分析与归因。

## 技术方案
为解决上述问题，本发明提供如下技术方案。

### 一种基于分解建模的延迟可得约束下节假日感知交通流量预测方法
该方法包括如下步骤：

**S1：数据输入与预处理**  
获取按天采样的交通流量序列数据，至少包括日期字段 `date` 与目标字段 `y`；对日期字段进行解析与排序，形成按时间有序的样本集合。

**S2：静态日历与节假日上下文特征构建**  
基于日期生成静态特征，包括但不限于：年/月/日、星期、年内日序、周末标识、周期性正余弦编码、法定节假日标识、调休工作日标识、节假日类型、距离上/下一个节假日的天数、节假日阶段与进度等。

**S3：春节窗口相对日特征构建**  
基于预设的春节日期表，为每个样本构建 `days_to_cny` 及窗口特征，包括是否处于春运窗口、节前/节后天数编码与春节当日标识。

**S4：训练期统计映射特征（group stats）构建**  
仅使用训练期样本的真实值 y，在类别变量上计算统计映射并映射回全量样本，所述类别变量包括但不限于：星期、月份、节假日类型、春节相对日（窗口内）；统计量包括但不限于均值与标准差，用以为模型提供稳定先验并提升小样本泛化。

**S5：延迟对齐的动态时序特征构建**  
设定信息延迟参数 `delay=k`，对每个样本日 t 的动态特征仅使用至 `t-k` 的真实值构造，动态特征包括但不限于：多阶滞后项、滚动均值/标准差、多尺度趋势与斜率、加速度、偏离度等，并通过 `shift(delay)` 机制保证不使用同日或未来真实值。

**S6：事件日识别（uplift mask）**  
根据静态特征判定事件日集合，事件日至少包括：法定节假日、春运窗口日；生成事件指示变量 `event(t)`。

**S7：训练常态基线模型（baseline_normal）**  
在训练集全量样本上，使用包含静态特征与动态特征的特征子集训练基线模型，以最小化预设损失函数，输出常态基线预测 `baseline_normal(t)`。

**S8：训练反事实基线模型（baseline_cf）**  
在训练集中仅使用非事件日样本训练反事实基线模型，得到“若无事件影响”的基线预测 `baseline_cf(t)`。

**S9：训练事件增量模型（uplift）**  
以训练集事件日样本为训练对象，构造残差标签：`residual(t) = y(t) - baseline_cf(t)`；使用节假日/春节窗口上下文特征作为主要输入，并将 `baseline_normal(t)` 与 `baseline_cf(t)` 作为辅助输入特征，训练增量模型预测 `uplift(t)`；所述增量模型可进一步按事件类型拆分为春节窗口增量模型与非春节法定节假日增量模型。

**S10：预测组合与输出**  
对目标预测期样本，若为非事件日，则输出 `ŷ(t)=baseline_normal(t)`；若为事件日，则输出 `ŷ(t)=baseline_cf(t)+uplift(t)`；同时输出至少包括 `baseline_cf(t)` 与 `uplift(t)` 以供解释分析，得到最终预测结果序列。

### 一种基于分解建模的延迟可得约束下节假日感知交通流量预测装置
该装置包括：
1) 数据处理模块，用于执行步骤 S1；  
2) 特征构建模块，用于执行步骤 S2~S5；  
3) 事件识别模块，用于执行步骤 S6；  
4) 基线训练模块，用于执行步骤 S7、S8；  
5) 增量训练模块，用于执行步骤 S9；  
6) 预测组合输出模块，用于执行步骤 S10。

### 一种计算机可读存储介质
所述存储介质上存储有计算机程序，所述程序被处理器执行时实现上述方法的步骤 S1~S10。

## 有益效果
与现有技术相比，本发明至少具有如下有益效果：
1) **严格满足 t-k 信息约束**：通过 `delay=k` 对齐动态特征，避免同日/未来真实值泄露，提升线上一致性；
2) **降低节假日/春运低估**：将常态与事件增量分开学习，缓解峰值稀疏导致的“常态更准、峰值吃亏”折中；
3) **可解释输出**：同时提供反事实基线与增量项，支持对事件影响的解释、对比与归因；
4) **小样本友好**：利用 group stats 先验与结构化分解，提升在仅少量年份数据下的稳定性。

# 附图说明
图1 为本发明方法的总体流程示意图；  
图2 为本发明分解建模的结构示意图（baseline_normal / baseline_cf / uplift / 组合输出）；  
图3 为本发明在春运窗口的预测曲线示意图（真实值、反事实基线、分解预测）。

# 具体实施方式
以下结合实施例对本发明进行说明，但本发明的保护范围不限于此。

## 实施例一：分解建模预测（baseline + uplift）
1) 数据准备：输入日频全国交通流量数据，包含 `date` 与 `y` 两列。  
2) 构建静态特征：由日期派生工作日/周末/节假日、距离/阶段等上下文特征；构建春节相对日坐标特征 `days_to_cny` 及窗口派生特征。  
3) 构建 group stats：仅用训练期（例如 2023~2024）样本统计星期/月/节假日类型/春节相对日的均值与标准差，并映射到全量样本。  
4) 构建动态特征：设置 `delay=k`，构造 `lag/roll/std/trend/slope/accel` 等动态特征，使预测日 t 的动态特征仅由 `t-k` 及以前真实 y 产生。  
5) 训练 baseline_normal：在训练期全量样本上拟合 `y(t)`。  
6) 训练 baseline_cf：在训练期非事件日样本上拟合 `y(t)`。  
7) 训练 uplift：在训练期事件日样本上拟合残差 `y(t)-baseline_cf(t)`，并将 `baseline_normal(t)`、`baseline_cf(t)` 注入 uplift 特征以增强水平感知。  
8) 输出：对预测期每一天输出最终预测 `ŷ(t)`，并同时输出反事实基线 `baseline_cf(t)` 与事件增量 `uplift(t)` 等分解分量，支持解释“事件增量贡献”。

## 实施例二：事件类型拆分的增量模型
在实施例一的基础上，将事件日分为春节窗口事件与非春节法定节假日事件，分别训练 `uplift_cny` 与 `uplift_holiday`，预测时按事件类型选择对应的增量模型，以提高对不同事件机制的拟合能力。

# （可选补充）输入输出细节示例：t-2 场景
在部分业务系统中，真实流量 y 的落地与核验存在固定延迟，预测日 t 的最新可用真实值为 t-2（即 k=2）。此时：
- 动态特征构建按 `delay=2` 执行，以保证特征仅使用至 t-2 的真实观测；
- 输出包含最终预测序列以及分解分量序列，便于对节假日/春运窗口的增量贡献进行解释。
该示例仅用于说明延迟对齐的输入输出边界，不限制本发明保护范围。

# 权利要求书
1. 一种基于分解建模的延迟可得约束下节假日感知交通流量预测方法，其特征在于，包括如下步骤：  
S1 获取按天采样的交通流量序列数据并按日期排序；  
S2 基于日期构建静态日历与节假日上下文特征；  
S3 基于预设春节日期表构建春节窗口相对日特征；  
S4 仅使用训练期真实值在类别变量上计算统计映射并映射回样本，得到训练期统计映射特征；  
S5 设置信息延迟参数 delay=k，k 为正整数，构建对齐延迟的信息边界的动态时序特征，使预测日 t 的动态时序特征仅由至 t-k 的真实值生成；  
S6 根据静态特征识别事件日并生成事件指示变量；  
S7 在训练集全量样本上训练常态基线模型得到 baseline_normal(t)；  
S8 在训练集中仅使用非事件日样本训练反事实基线模型得到 baseline_cf(t)；  
S9 在训练集事件日样本上以 residual(t)=y(t)-baseline_cf(t) 为标签训练事件增量模型得到 uplift(t)，并将 baseline_normal(t) 与 baseline_cf(t) 作为增量模型的辅助输入特征；  
S10 对预测期样本，非事件日输出 ŷ(t)=baseline_normal(t)，事件日输出 ŷ(t)=baseline_cf(t)+uplift(t)，并输出至少包括 baseline_cf(t) 与 uplift(t) 的分解结果。

2. 根据权利要求1所述的方法，其特征在于，所述静态日历与节假日上下文特征至少包括：周末标识、法定节假日标识、调休工作日标识、节假日类型、距离上一/下一节假日天数、节假日阶段与进度特征中的一种或多种。

3. 根据权利要求1所述的方法，其特征在于，所述春节窗口相对日特征至少包括：days_to_cny、春节窗口标识、节前天数编码、节后天数编码、春节当日标识中的一种或多种。

4. 根据权利要求1所述的方法，其特征在于，所述训练期统计映射特征至少包括：按星期、月份、节假日类型及春节相对日统计得到的均值与标准差映射中的一种或多种。

5. 根据权利要求1所述的方法，其特征在于，所述动态时序特征至少包括：多阶滞后项、滚动均值、滚动标准差、趋势项、线性斜率、趋势加速度、偏离度特征中的一种或多种。

6. 根据权利要求1所述的方法，其特征在于，所述事件日包括法定节假日与春运窗口日中的一种或多种。

7. 根据权利要求1所述的方法，其特征在于，所述事件增量模型按事件类型拆分为春节窗口增量模型与非春节法定节假日增量模型，并在预测期按事件类型选择对应增量模型输出 uplift(t)。

8. 一种基于分解建模的延迟可得约束下节假日感知交通流量预测装置，其特征在于，包括：数据处理模块、特征构建模块、事件识别模块、基线训练模块、增量训练模块与预测组合输出模块，所述模块分别用于执行权利要求1所述方法的步骤 S1 至 S10。

9. 一种计算机设备，包括处理器与存储器，其特征在于，所述存储器中存储有计算机程序，所述程序被所述处理器执行时实现权利要求1至7任一项所述的方法。

10. 一种计算机可读存储介质，其特征在于，所述存储介质上存储有计算机程序，所述程序被处理器执行时实现权利要求1至7任一项所述的方法。
